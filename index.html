<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Always 8 Baccarat — CMS Simulator</title>
<style>
  :root { --p:#3b82f6; --b:#ef4444; --t:#10b981; }
  body { font-family: system-ui, Arial, sans-serif; padding: 14px; max-width: 1100px; margin: 0 auto; }
  h1 { margin: 0 0 10px; }
  .controls { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 6px; }
  button { padding: 10px 12px; font-size: 16px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
  button:hover { background: #f6f6f6; }
  .section { padding: 10px; border: 1px solid #eee; border-radius: 14px; margin: 10px 0; background: #fafafa; }
  .row { display: flex; flex-wrap: wrap; gap: 12px; }
  .grow { flex: 1 1 320px; }
  .card-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
  .pill { padding: 6px 10px; border-radius: 999px; background: #fff; border: 1px solid #ddd; }
  #history { display: flex; flex-wrap: wrap; gap: 6px; }
  .history-card { padding: 7px 10px; border: 1px solid #ccc; border-radius: 8px; background: #fff; font-weight: 600; }
  .counts { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; }
  th, td { border-bottom: 1px solid #eee; padding: 8px 10px; text-align: left; vertical-align: top; }
  th { background: #f3f4f6; font-weight: 700; }
  .roadmap { display: grid; grid-template-columns: repeat(auto-fill, minmax(14px, 14px)); gap: 6px; }
  .dot { width: 14px; height: 14px; border-radius: 50%; }
  .dot.p { background: var(--p); }
  .dot.b { background: var(--b); }
  .dot.t { background: var(--t); }
  .bad { color: #b91c1c; font-weight: 700; }
</style>
</head>
<body>

<h1>Always 8 Baccarat — CMS Simulator</h1>

<div class="controls">
  <button onclick="initializeCMS()">Initialize (8×52)</button>
  <button onclick="dealCards(1)">Deal 1</button>
  <button onclick="dealCards(5)">Deal 5</button>
  <button onclick="dealRound()">Deal Round</button>
  <button onclick="shuffleBack()">Shuffle Back (CMS)</button>
  <button onclick="hardReset()">Reset All</button>
  <span id="deckMeta" class="pill">—</span>
</div>

<div class="section">
  <div class="row">
    <div class="grow">
      <h3>Manual Tap: choose a rank that was dealt</h3>
      <div id="cardButtons" class="card-buttons"></div>
      <div style="margin-top:8px;font-size:13px;color:#555">Manual taps remove that rank from the live deck and append it to the History. Use <b>Shuffle Back</b> to return them into the shoe randomly (CMS style).</div>
    </div>
    <div class="grow">
      <h3>Remaining Counts</h3>
      <div id="counts" class="counts">—</div>
      <h3 style="margin-top:10px">Next Card Probabilities</h3>
      <div id="probs" class="counts">—</div>
    </div>
  </div>
</div>

<div class="section">
  <h3>History (Tapped/Dealt Cards)</h3>
  <div id="history">—</div>
</div>

<div class="section">
  <div class="row">
    <div class="grow">
      <h3>Round Results (Growing Table)</h3>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Player Hand (total)</th>
            <th>Banker Hand (total)</th>
            <th>Outcome</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
    <div class="grow">
      <h3>Mini Roadmap</h3>
      <div id="roadmap" class="roadmap"></div>
      <div style="margin-top:8px;font-size:12px;">
        <span class="pill" style="background:var(--p);color:#fff;border:none;">Player</span>
        <span class="pill" style="background:var(--b);color:#fff;border:none;">Banker</span>
        <span class="pill" style="background:var(--t);color:#fff;border:none;">Tie</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- State ---------- */
const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
let deck = [];          // live deck (ranks only), 8 decks total
let tapHistory = [];    // every manually tapped or auto-dealt card
let roundNo = 0;

/* ---------- Helpers ---------- */
const rankValue = (r) => (r==="A"?1: r==="10"||r==="J"||r==="Q"||r==="K"?0: parseInt(r,10));
const handTotal = (arr) => (arr.reduce((s,r)=>s+rankValue(r),0) % 10);

function updateDeckMeta(){
  document.getElementById("deckMeta").innerText = `Remaining: ${deck.length} cards`;
}

function renderCountsAndProbs(){
  const counts = {};
  deck.forEach(r => counts[r]=(counts[r]||0)+1);
  const order = RANKS;
  const countsStr = order.map(r => `${r}=${counts[r]||0}`).join("  ");
  document.getElementById("counts").innerText = deck.length? countsStr : "—";

  if(!deck.length){ document.getElementById("probs").innerText = "—"; return; }
  const probsStr = order
    .map(r => `${r}:${(((counts[r]||0)/deck.length)*100).toFixed(1)}%`)
    .join("  ");
  document.getElementById("probs").innerText = probsStr;
}

function renderHistory(){
  const wrap = document.getElementById("history");
  if(!tapHistory.length){ wrap.innerHTML = "—"; return; }
  wrap.innerHTML = "";
  tapHistory.forEach(r=>{
    const div = document.createElement("div");
    div.className = "history-card";
    div.textContent = r;
    wrap.appendChild(div);
  });
}

function buildCardButtons(){
  const box = document.getElementById("cardButtons");
  box.innerHTML = "";
  RANKS.forEach(r=>{
    const btn = document.createElement("button");
    btn.textContent = r;
    btn.onclick = ()=>manualTap(r);
    box.appendChild(btn);
  });
}

/* ---------- CMS / Deck Ops ---------- */
function initializeCMS(){
  deck = [];
  tapHistory = [];
  // 8 decks × 4 suits per rank
  for(let d=0; d<8; d++){
    RANKS.forEach(r=>{
      for(let s=0; s<4; s++){
        deck.push(r);
      }
    });
  }
  shuffleArray(deck);
  roundNo = 0;
  document.getElementById("resultsBody").innerHTML = "";
  document.getElementById("roadmap").innerHTML = "";
  renderHistory();
  updateDeckMeta();
  renderCountsAndProbs();
  if(!document.getElementById("cardButtons").children.length) buildCardButtons();
}

function hardReset(){
  deck = [];
  tapHistory = [];
  roundNo = 0;
  document.getElementById("resultsBody").innerHTML = "";
  document.getElementById("roadmap").innerHTML = "";
  renderHistory();
  updateDeckMeta();
  renderCountsAndProbs();
}

function shuffleArray(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

function shuffleBack(){
  if(!tapHistory.length){ alert("No cards in history to shuffle back."); return; }
  // Insert each history card into a random spot (CMS behavior)
  while(tapHistory.length){
    const c = tapHistory.shift();
    const pos = Math.floor(Math.random()*(deck.length+1));
    deck.splice(pos,0,c);
  }
  renderHistory();
  updateDeckMeta();
  renderCountsAndProbs();
}

/* ---------- Manual tap ---------- */
function manualTap(rank){
  const idx = deck.indexOf(rank);
  if(idx===-1){ alert(`No ${rank} left in the live shoe.`); return; }
  const card = deck.splice(idx,1)[0];
  tapHistory.push(card);
  renderHistory();
  updateDeckMeta();
  renderCountsAndProbs();
}

/* ---------- Simple deals (no rules) ---------- */
function dealCards(n){
  if(!deck.length){ alert("Deck empty. Initialize first."); return; }
  const dealt = [];
  for(let i=0;i<n && deck.length;i++){
    dealt.push(deck.shift());
  }
  if(!dealt.length) return;
  tapHistory.push(...dealt);
  renderHistory();
  updateDeckMeta();
  renderCountsAndProbs();
}

/* ---------- Round logic (Baccarat) ---------- */
/* Always-8 twist: Banker's first card is considered pre-placed on table.
   We model that by drawing the first Banker card from top *first*,
   then Player gets two, then Banker receives second card.
   After that we check naturals and third-card rules. */

function dealRound(){
  if(deck.length < 4){ alert("Not enough cards. Initialize or shuffle back."); return; }

  // 1) Banker first pre-placed
  const banker = [ drawTop(), /* placeholder for second later */ ];
  // 2) Player two cards
  const player = [ drawTop(), drawTop() ];
  // 3) Banker second card now
  banker[1] = drawTop();

  // Check naturals
  let pTotal = handTotal(player);
  let bTotal = handTotal(banker);
  let notes = [];
  if(pTotal===8 || pTotal===9 || bTotal===8 || bTotal===9){
    notes.push("Natural");
    finishRound(player, banker, notes);
    return;
  }

  // Player action
  let playerThird = null;
  if(pTotal<=5){
    playerThird = drawTop();
    player.push(playerThird);
    pTotal = handTotal(player);
  }

  // Banker action
  bTotal = handTotal(banker);
  let bankerThird = null;

  if(playerThird===null){
    // Player stood on 6/7
    if(bTotal<=5){
      bankerThird = drawTop();
      banker.push(bankerThird);
      bTotal = handTotal(banker);
    }
  } else {
    // Player drew; use full banker table
    const x = rankValue(playerThird); // player 3rd value
    if(bTotal<=2){
      bankerThird = drawTop();
    } else if(bTotal===3){
      bankerThird = (x!==8) ? drawTop() : null;
    } else if(bTotal===4){
      bankerThird = (x>=2 && x<=7) ? drawTop() : null;
    } else if(bTotal===5){
      bankerThird = (x>=4 && x<=7) ? drawTop() : null;
    } else if(bTotal===6){
      bankerThird = (x===6 || x===7) ? drawTop() : null;
    } // 7 stands
    if(bankerThird){ banker.push(bankerThird); bTotal = handTotal(banker); }
  }

  finishRound(player, banker, notes);
}

function drawTop(){
  if(!deck.length){ throw new Error("Deck empty mid-round."); }
  const c = deck.shift();
  tapHistory.push(c);
  return c;
}

function finishRound(player, banker, notes){
  const pTotal = handTotal(player);
  const bTotal = handTotal(banker);

  let outcome, dotClass;
  if(pTotal > bTotal){ outcome = "Player"; dotClass = "p"; }
  else if(bTotal > pTotal){ outcome = "Banker"; dotClass = "b"; }
  else { outcome = "Tie"; dotClass = "t"; }

  roundNo += 1;

  // Append table row
  const tbody = document.getElementById("resultsBody");
  const tr = document.createElement("tr");
  const td = (txt)=>{ const t=document.createElement("td"); t.innerHTML = txt; return t; };

  const pTxt = `${player.join(", ")} <b>(${pTotal})</b>`;
  const bTxt = `${banker.join(", ")} <b>(${bTotal})</b>`;
  tr.appendChild(td(`#${roundNo}`));
  tr.appendChild(td(pTxt));
  tr.appendChild(td(bTxt));
  tr.appendChild(td(`<b>${outcome}</b>`));
  tr.appendChild(td(notes.join(", ") || "—"));
  tbody.appendChild(tr);

  // Roadmap dot
  const road = document.getElementById("roadmap");
  const dot = document.createElement("div");
  dot.className = `dot ${dotClass}`;
  road.appendChild(dot);

  // Refresh side panels
  renderHistory();
  updateDeckMeta();
  renderCountsAndProbs();
}
</script>
</body>
  </html>
